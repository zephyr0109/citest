pipeline{
    agent any
    environment {
        DOCKER_CREDENTIALS = 'docker-hub'
        GITHUB_CREDENTIALS = 'git-hub'
        IMAGE_REPOSITORY = 'zephyr0109/cicdtest'
    }

    // CI Pipeline
    stages {
        stage( 'Checkout') {
            steps {
                checkout scm
            }
        }

        stage("Set Image Tag") {
            steps {
                script {
                    IMAGE_TAG = sh(
                        script : "git rev-parse --short HEAD",
                        returnStdout : true
                    ).trim()
                }
            }
        }

        stage("Build"){
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage("Test") {
            steps {
                sh "mvn test"
            }
        }

        stage("Build Docker Image"){
            steps {
                sh "docker build -t ${IMAGE_REPOSITORY}:latest ."
            }
        }

        stage("Push Docker Image"){
            steps {
                withCredentials([usernamePassword(credentialsId : "$DOCKER_CREDENTIALS",
                passwordVariable: "DOCKER_PASS",
                usernameVariable: "DOCKER_USER")]){
                    sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                    sh "docker push ${IMAGE_REPOSITORY}:${IMAGE_TAG}"
                    sh "docker push ${IMAGE_REPOSITORY}:latest"
                }
            }
        }
    }

    post {
        always {
            echo "CI pipeline finished"

        }
        success {
            echo "Build and push successful, IMAGE_TAG = ${IMAGE_TAG}"

        }
        failure {
            echo "Build or test failed"
        }
    }
}
