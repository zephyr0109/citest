pipeline{
    agent any
    environment {
            DOCKER_CREDENTIALS = 'docker-hub'
            GITHUB_CREDENTIALS = 'git-hub'
            IMAGE_REPOSITORY = 'zephyr0109/cicdtest'
    }
    parameters {
        choice(
            name: 'IMAGE_TAG',
            choices: ['latest'],  // Active Choice 단계에서 실제 태그로 자동 주입됨
            description: '배포할 도커 이미지 태그 선택'
        )
    }

    stages{
        stage("Pull docker image") {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: "$DOCKER_CREDENTIALS",
                        passwordVariable: "DOCKER_PASS",
                        usernameVariable: "DOCKER_USER"
                    )
                ]) {
                // 여기 주목, latest 대신 IMAGE_TAG를 활용
                    sh """
                        echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                        docker pull ${IMAGE_REPOSITORY}:${IMAGE_TAG}
                    """
                }
            }

        }
        stage("Clean"){
            steps {
                sh "docker stop hello-ci-web || true"
                sh "docker rm hello-ci-web || true"
            }

        }
        stage("Deploy"){
            steps {
                // 여기 주목, IMAGE_TAG 활용
                sh "docker run -d --name hello-ci-web -p 8080:8080 ${IMAGE_REPOSITORY}:${IMAGE_TAG}"
            }
        }

        stage("Health check"){
                steps{
                  sh """
                    echo 'Waiting for app to start'
                    sleep 10
                    curl -f http://localhost:8080/
                 """
            }
        }
    }
    post {
        always {
            echo "CD pipeline finished"
        }
        success {
            echo "CD successful: container deployed, Image Tag : ${IMAGE_TAG}"
        }
        failure {
            echo "CD failed, Image Tag : ${IMAGE_TAG}"
        }
    }
}